<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Golden Ratio Timer</title>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400|Lora:400,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
<style>
:root {
  --golden: 1.618;
  --base: 20px;
  --accent: #ffd700;
  --bg: #181f2a;
  --bg-gradient: linear-gradient(135deg, #181f2a 0%, #222b3c 100%);
  --card: #242f42;
  --card2: #1a2232;
  --text: #fafafa;
  --muted: #b4b4b4;
  --input: #1a2232;
  --border: #ffd70055;
  --space: calc(var(--base) * var(--golden));
  --success: #4CAF50;
  --warning: #FFC107;
  --danger: #F44336;
  --scary-bg: #000;
  --scary-text: #ff0000;
}
body {
  margin: 0;
  background: var(--bg-gradient);
  min-height: 100vh;
  color: var(--text);
  font-family: 'Lora', serif;
  overflow-x: hidden;
}
#container, #chatContainer {
  max-width: 700px;
  margin: 0 auto;
  padding: calc(var(--space)*0.6);
}
#chatContainer { display: none; }
h1 {
  font-family: 'Montserrat', sans-serif;
  font-size: calc(var(--base) * var(--golden) * 1.2);
  text-align: center;
  margin-top: var(--space);
  margin-bottom: 0.3em;
  color: var(--accent);
  letter-spacing: 0.02em;
}
.subtitle {
  font-size: calc(var(--base) * var(--golden) / 1.2);
  text-align: center;
  color: var(--muted);
  margin-bottom: var(--space);
  font-family: 'Montserrat', sans-serif;
}
#timerCard {
  background: var(--card);
  border-radius: calc(var(--base)*0.8);
  box-shadow: 0 8px 32px #0003;
  padding: var(--space);
  margin-bottom: var(--space);
  border: 1.5px solid var(--border);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#timerInput {
  width: 70%;
  padding: calc(var(--base)/1.5);
  margin-bottom: calc(var(--base)/1.2);
  border: none;
  border-radius: calc(var(--base)*0.5);
  background: var(--input);
  color: var(--text);
  font-size: calc(var(--base) * var(--golden) / 1.2);
  font-family: 'Lora', serif;
  box-shadow: 0 2px 8px #0002;
  outline: none;
  transition: background 0.14s;
  text-align: center;
}
#timerInput:focus {
  background: #232f4e;
}
#startBtn, #fullscreenBtn {
  display: block;
  width: 70%;
  background: var(--accent);
  color: var(--bg);
  font-family: 'Montserrat', sans-serif;
  font-size: calc(var(--base)*var(--golden)/1.2);
  padding: calc(var(--base)/1.1) 0;
  border: none;
  border-radius: calc(var(--base)*0.6);
  font-weight: 700;
  box-shadow: 0 2px 8px #0003;
  cursor: pointer;
  transition: background 0.18s;
  margin-top: calc(var(--base)/2);
}
#startBtn:hover, #fullscreenBtn:hover {
  background: #ffe066;
}
#timerError {
  color: #e53935;
  font-weight: 700;
  margin-top: 0.5em;
  display: none;
  text-align: center;
}
#timerDisplay {
  font-family: 'Montserrat', monospace;
  font-size: calc(var(--base) * var(--golden) * 2.2);
  color: var(--accent);
  letter-spacing: 0.12em;
  margin: calc(var(--base)*1.2) 0;
  text-align: center;
  background: var(--card2);
  border-radius: calc(var(--base)*0.7);
  box-shadow: 0 2px 16px #0003;
  padding: calc(var(--base)*1.2);
  width: 95%;
  user-select: none;
}
#timerActions {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1.618em;
  margin-top: 1em;
}
#timerActions button {
  background: var(--card2);
  color: var(--accent);
  font-family: 'Montserrat', sans-serif;
  font-size: calc(var(--base)*var(--golden)/1.4);
  padding: 0.7em 1.618em;
  border: none;
  border-radius: calc(var(--base)*0.5);
  font-weight: 700;
  box-shadow: 极狐 0 2px 8px #0002;
  cursor: pointer;
  transition: background 0.16s;
}
#timerActions button:hover {
  background: #ffd70033;
}
#formCard {
  background: var(--card);
  border-radius: calc(var(--base)*0.8);
  box-shadow: 0 8px 32px #0003;
  padding: var(--space);
  margin-bottom: var(--space);
  border: 1.5px solid var(--border);
  position: relative;
}
#formCard label {
  display: block;
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  margin-bottom: 0.2em;
  color: var(--accent);
  font-size: calc(var(--base)*1.02);
}
#formCard input, #form极狐 textarea {
  width: 100%;
  padding: calc(var(--base)/1.5);
  margin-bottom: calc(var(--base)/1.2);
  border: none;
  border-radius: calc(var(--base)*0.5);
  background: var(--input);
  color: var(--text);
  font-size: calc(var(--base) * var(--golden) / 1.4);
  font-family: 'Lora', serif;
  box-shadow: 0 2px 8px #0002;
  outline: none;
  transition: background 0.14s;
}
#formCard input:focus, #formCard textarea:focus {
  background: #232f4e;
}
#formCard button {
  display: block;
  width: 100%;
  background: var(--accent);
  color: var(--bg);
  font-family: 'Montserrat', sans-serif;
  font-size: calc(var(--base)*var(--golden)/1.2);
  padding: calc(var(--base)/1.1) 0;
  border: none;
  border-radius: calc(var(--base)*0.6);
  font-weight: 700;
  box-shadow: 0 2px 8px #0003;
  cursor: pointer;
  transition: background 0.18s;
  margin-top: calc(var(--base)/2);
}
#formCard button:hover {
  background: #ffe066;
}
#clearBtn {
  background: #e53935;
  color: #fff;
  font-size: calc(var(--base)*var(--golden)/1.3);
  margin-top: calc(var(--base)/2);
  margin-bottom: 0;
  border-radius: calc(var(--base)*0.6);
  box-shadow: 0 2px 10px #0003;
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
}
#clearBtn:hover {
  background: #b71c1c;
}
#scrollBottomBtn {
  width: 100%;
  background: var(--accent);
  color: var(--bg);
  font-size: 1.1em;
  font-family: 'Montserrat',sans-serif;
  font-weight: 700;
  border: none;
  border-radius: 0.6em;
  box-shadow: 0 2px 8px #0003;
  margin-bottom: 1em;
  cursor: pointer;
}
#wall {
  min-height: calc(var(--space)*2);
  max-height: 50vh;
  overflow-y: auto;
  padding-top: 0.5em;
  padding-bottom: 1em;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
.msgCard {
  background: var(--card2);
  border-radius: calc(var(--base)*0.6);
  box-shadow: 0 2px 12px #0002;
  padding: calc(var(--base)*0.9) calc(var(--base)*1.2);
  margin-bottom: calc(var(--base)*0.9);
  border-left: 6px solid var(--accent);
  animation: fadeInMsg 0.7s cubic-bezier(.84,0,.93,.68);
  position: relative;
}
@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(25px);}
  to { opacity: 1; transform: translateY(0);}
}
.msgHeader {
  display: flex;
  align-items: center;
  margin-bottom: 0.7em;
}
.msgName {
  font-family: 'Montserrat', sans-serif;
  color: var(--accent);
  font-size: calc(var(--base)*var(--golden)/1.35);
  font-weight: 700;
  margin-right: 0.8em;
  letter-spacing: 0.03em;
}
.msgTime {
  font-size: calc(var(--base)*0.95);
  color: var(--muted);
  font-family: 'Montserrat', sans-serif;
}
.msgText {
  font-size: calc(var(--base)*var(--golden)/1.18);
  color: var(--text);
  line-height: 1.618;
  word-break: break-word;
}
.edit-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.1);
  color: var(--accent);
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}
.msgCard:hover .edit-btn {
  opacity: 1;
}
#clearModal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(24,31,42,0.92);
  justify-content: center;
  align-items: center;
}
#clearModalContent {
  background: var(--card);
  border-radius: calc(var(--base)*0.8);
  box-shadow: 0 8px 32px #0006;
  padding: var(--space);
  border: 2px solid var(--accent);
  color: var(--text);
  display: flex;
  flex-direction: column;
  min-width: 260px;
}
#clearModalContent label {
  color: var(--accent);
  font-size: calc(var(--base)*var(--golden)/1.3);
  font-weight: 700;
  margin-bottom: 0.5em;
}
#clearModalContent input {
  background: var(--input);
  color: var(--text);
  border: none;
  border-radius: calc(var(--base)*0.5);
  font-size: calc(var(--base)*var(--golden)/1.4);
  padding: calc(var(--base)/1.5);
  margin-bottom: 1em;
  font-family: 'Lora', serif;
}
#clearModalContent button {
  background: var(--accent);
  color: var(--bg);
  font-family: 'Montserrat', sans-serif;
  font-size: calc(var(--base)*var(--golden)/1.2);
  padding: calc(var(--base)/1.1) 0;
  border: none;
  border-radius: calc(var(--base)*0.6);
  font-weight: 700;
  box-shadow: 0 2px 8px #0003;
  cursor: pointer;
  transition: background 0.18s;
  margin-bottom: 0.5em;
}
#clearModalContent button:last-child {
  background: #e53935;
  color: #fff;
}
#clearModalContent button:last-child:hover {
  background: #b71c1c;
}
#clearError {
  color: #e53935;
  font-weight: 700;
  margin-bottom: 0.5em;
  display: none;
}
#timerFullscreen {
  position: fixed;
  z-index: 99999;
  top: 0; left: 0; right: 0; bottom: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: #181f2a;
}
#timerFullscreenContent {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
#timerFullscreenDisplay {
  font-family: 'Montserrat', monospace;
  font-size: min(13vw, 13vh, 120px);
  color: var(--accent);
  background: var(--card);
  border-radius: calc(var(--base)*2);
  padding: 2em 2.618em;
  box-shadow: 0 6px 32px #0006;
  text-align: center;
  user-select: none;
}
#timerFullscreenExitBtn {
  position: absolute;
  top: 2vw;
  right: 2vw;
  background: #e53935;
  color: #fff;
  font-family: 'Montserrat', sans-serif;
  font-size: min(4vw, 24px);
  padding: 0.8em 1.618em;
  border: none;
  border-radius: 1em;
  font-weight: 700;
  box-shadow: 0 2px 8px #0006;
  cursor: pointer;
}
#timerFullscreenExitBtn:hover {
  background: #b71c1c;
}
/* Apps button only for chat page */
#appsBtn {
  position: fixed;
  left: 25px;
  bottom: 25px;
  z-index: 11000;
  background: #ffd700;
  color: #181f2a;
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: 1.08em;
  padding: 0.85em 1.3em;
  border-radius: 1em;
  box-shadow: 0 2px 12px #0003;
  text-decoration: none;
  transition: background 0.16s, color 0.16s;
  display: none;
}
#appsBtn.show {
  display: block;
}
#appsBtn:hover, #appsBtn:focus {
  background: #ffe066;
  color: #000;
}
/* Admin panel */
#adminPanel {
  background: var(--card);
  border-radius: calc(var(--base)*0.8);
  padding: var(--space);
  margin-bottom: var(--space);
  border: 1.5px solid var(--border);
  display: none;
}
#adminPanel h2 {
  color: var(--accent);
  font-family: 'Montserrat', sans-serif;
  margin-top: 0;
  margin-bottom: 0.8em;
}
#adminRequests {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 1em;
}
.request-item {
  background: var(--card2);
  padding: 0.8em;
  margin-bottom: 0.8em;
  border-radius: 0.5em;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.request-info {
  flex: 1;
}
.request-actions {
  display: flex;
  gap: 0.5em;
}
.request-btn {
  padding: 0.4em 0.8em;
  border: none;
  border-radius: 0.4em;
  cursor: pointer;
  font-weight: bold;
}
.approve-btn {
  background: var(--success);
  color: white;
}
.deny-btn {
  background: var(--danger);
  color: white;
}
/* Edit modal */
#editModal {
  display: none;
  position: fixed;
  z-index: 10001;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(24,31,42,0.92);
  justify-content: center;
  align-items: center;
}
#editModalContent {
  background: var(--card);
  border-radius: calc(var(--base)*0.8);
  box-shadow: 0 8px 32px #0006;
  padding: var(--space);
  border: 2px solid var(--accent);
  color: var(--text);
  display: flex;
  flex-direction: column;
  min-width: 300px;
  max-width: 90%;
}
#editModalContent h2 {
  color: var(--accent);
  margin-top: 0;
}
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 5px;
  font-family: 'Montserrat', sans-serif;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 10002;
  opacity: 0;
  transform: translateY(-30px);
  transition: opacity 0.3s, transform 0.3s;
}
.notification.show {
  opacity: 1;
  transform: translateY(0);
}
.notification.success {
  background-color: var(--success);
  color: white;
}
.notification.error {
  background-color: var(--danger);
  color: white;
}
/* Admin stats */
.admin-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1em;
  margin-bottom: 1.5em;
}
.stat-card {
  background: var(--card2);
  border-radius: 0.5em;
  padding: 1em;
  text-align: center;
}
.stat-value {
  font-size: 1.8em;
  font-weight: bold;
  color: var(--accent);
  margin: 0.2em 0;
}
.stat-label {
  font-size: 0.9em;
  color: var(--muted);
}
/* Scary message overlay */
#scaryOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--scary-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 20000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#scaryMessage {
  font-family: 'Creepster', cursive;
  font-size: 3em;
  color: var(--scary-text);
  text-align: center;
  text-shadow: 0 0 10px rgba(255,0,0,0.5);
  padding: 1em;
  max-width: 90%;
}
#scaryOverlay.active {
  opacity: 1;
  pointer-events: all;
}
/* Ban message */
#banMessage {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 30000;
  color: #ff0000;
  font-family: 'Creepster', cursive;
  font-size: 3em;
  text-align: center;
  padding: 1em;
  display: none;
}
#banMessage p {
  margin: 0.5em 0;
}
/* Admin tabs */
.admin-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 1em;
}
.admin-tab {
  padding: 0.5em 1em;
  background: var(--card2);
  border: none;
  border-radius: 0.3em;
  color: var(--text);
  cursor: pointer;
  font-family: 'Montserrat', sans-serif;
  font-weight: bold;
}
.admin-tab.active {
  background: var(--accent);
  color: var(--bg);
}
.admin-tab-content {
  display: none;
}
.admin-tab-content.active {
  display: block;
}
/* User management */
.user-list {
  max-height: 300px;
  overflow-y: auto;
}
.user-item {
  background: var(--card2);
  padding: 0.8em;
  margin-bottom: 0.8em;
  border-radius: 0.5em;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.user-info {
  flex: 1;
}
.user-actions {
  display: flex;
  gap: 0.5em;
}
.user-btn {
  padding: 0.4em 0.8em;
  border: none;
  border-radius: 0.4em;
  cursor: pointer;
  font-weight: bold;
}
.ban-btn {
  background: var(--danger);
  color: white;
}
.unban-btn {
  background: var(--success);
  color: white;
}
.message-btn {
  background: var(--warning);
  color: black;
}
/* Scary message form */
.scary-form {
  display: flex;
  flex-direction: column;
  gap: 1em;
}
.scary-form textarea {
  min-height: 100px;
}
.scary-form button {
  align-self: flex-start;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="container">
  <h1>Golden Ratio Timer</h1>
  <div class="subtitle">Set a timer. Format: <b>hours:minutes:seconds</b> (Examples: <i>5:30</i>, <i>30</i>, <i>1:5:30</i>)</div>
  <div id="timerCard">
    <input type="text" id="timerInput" placeholder="Enter time (e.g. 1:20, 30, 0:2:00)">
    <button id="startBtn">Start Timer</button>
    <button id="fullscreenBtn">Fullscreen</button>
    <div id="timerError"></div>
    <div id="timerDisplay">00:00:00</div>
    <div id="timerActions">
      <button id="pauseBtn" disabled>Pause</button>
      <button id="resetBtn" disabled>Reset</button>
    </div>
  </div>
</div>

<div id="chatContainer" style="display:none;">
  <h1 style="color:var(--accent);font-family:'Montserrat',sans-serif;text-align:center;">Golden Ratio Text Wall</h1>
  <div class="subtitle" style="text-align:center;">Share your thoughts, stories, or messages. Timeless beauty, forever visible.</div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>

    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="stats">Statistics</button>
      <button class="admin-tab" data-tab="users">User Management</button>
      <button class="admin-tab" data-tab="requests">Clearance Requests</button>
      <button class="admin-tab" data-tab="scary">Send Scary Message</button>
    </div>

    <div id="statsTab" class="admin-tab-content active">
      <div class="admin-stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalVisits">0</div>
          <div class="stat-label">Total Visits</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="todayVisits">0</div>
          <div class="stat-label">Today's Visits</极狐div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="uniqueUsers">0</div>
          <div class="stat-label">Unique Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="onlineUsers">0</div>
          <div class="stat-label">Online Now</div>
        </div>
      </div>
    </div>

    <div id="usersTab" class="admin-tab-content">
      <div class="user-list" id="userList">
        <!-- User items will be added here -->
      </div>
    </div>

    <div id="requestsTab" class="admin-tab-content">
      <div id="adminRequests">
        <!-- Clearance requests will appear here -->
      </div>
    </div>

    <div id="scaryTab" class="admin-tab-content">
      <div class="scary-form">
        <label for="scaryTarget">Select User:</label>
        <select id="scaryTarget">
          <option value="">Select a user</option>
        </select>
        <label for="scaryMessageText">Scary Message:</label>
        <textarea id="scaryMessageText" placeholder="Enter terrifying message..."></textarea>
        <button id="sendScaryBtn">Send Scary Message</button>
      </div>
    </div>
  </div>

  <div id="formCard">
    <form id="sendForm" autocomplete="off">
      <label for="nameInput">Your Name</label>
      <input type="text" id="nameInput" maxlength="22" placeholder="Enter your name..." required>
      <label for="textInput">Your Message</label>
      <textarea id="textInput" maxlength="500" rows="4" placeholder="What do you want to share?" required></textarea>
      <button type="submit">Send Message</button>
    </form>
    <button id="clearBtn" type="button">Clear Wall</button>
  </div>
  <button id="scrollBottomBtn" type="button">Scroll to Latest</button>
  <div id="wall"></div>
  <!-- Apps Button - only visible on chat page -->
  <a href="apps.html" id="appsBtn" title="Apps">Apps</a>
</div>

<!-- Clear Modal -->
<div id="clearModal">
  <div id="clearModalContent">
    <label for="clearPassword">Enter clearance password:</label>
    <input type="password" id="clearPassword" placeholder="Password">
    <div id="clearError"></div>
    <button id="confirmClearBtn">Request Clearance</button>
    <button id="cancelClearBtn">Cancel</button>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal">
  <div id="editModalContent">
    <h2>Edit Message</h2>
    <label for="editName">Name:</label>
    <input type="text" id="editName" maxlength="22" required>
    <label for="editText">Message:</label>
    <textarea id="editText" maxlength="500" rows="4" required></textarea>
    <label for="editTime">Timestamp:</label>
    <input type="text" id="editTime" disabled>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="saveEditBtn" style="flex:1;">Save Changes</button>
      <button id="cancelEditBtn" style="flex:1; background: #666;">Cancel</button>
    </div>
  </div>
</div>

<!-- Timer Fullscreen -->
<div id="timerFullscreen">
  <div id="timerFullscreenContent">
    <div id="timerFullscreenDisplay">00:00:00</div>
    <button id="timerFullscreenExitBtn">Exit Fullscreen</button>
  </div>
</div>

<!-- Scary Message Overlay -->
<div id="scaryOverlay">
  <div id="scaryMessage"></div>
</div>

<!-- Ban Message -->
<div id="banMessage">
  <p>This website retired forever</p>
  <p>RIP timer</p>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDCtiOEsg0iNAIxkc-wBD_Kh6oRpwqTLQw",
  authDomain: "dffr-f1f5c.firebaseapp.com",
  databaseURL: "https://dffr-f1f5c-default-rtdb.firebaseio.com",
  projectId: "dffr-f1f5c",
  storageBucket: "dffr-f1f5c.appspot.com",
  messagingSenderId: "1087054401424",
  appId: "1:1087054401424:web:ee1e3bef36e6b20d0f2d15"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// Passwords
const USER_PASSWORD = "nimv001+haha";
const ADMIN_PASSWORD = "stoooppOI00";
const CLEARANCE_PASSWORD = "clirTHISpencil";

// DOM Elements
const timerInput = document.getElementById('timerInput');
const startBtn = document.getElementById('startBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const timerError = document.getElementById('timerError');
const timerDisplay = document.getElementById('timerDisplay');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const chatContainer = document.getElementById('chatContainer');
const mainContainer = document.getElementById('container');
const appsBtn = document.getElementById('appsBtn');
const adminPanel = document.getElementById('adminPanel');
const scaryOverlay = document.getElementById('scaryOverlay');
const scaryMessage = document.getElementById('scaryMessage');
const banMessage = document.getElementById('banMessage');
const adminTabs = document.querySelectorAll('.admin-tab');
const tabContents = document.querySelectorAll('.admin-tab-content');
const userList = document.getElementById('userList');
const scaryTarget = document.getElementById('scaryTarget');
const scaryMessageText = document.getElementById('scaryMessageText');
const sendScaryBtn = document.getElementById('sendScaryBtn');
const totalVisits = document.getElementById('totalVisits');
const todayVisits = document.getElementById('todayVisits');
const uniqueUsers = document.getElementById('uniqueUsers');
const onlineUsers = document.getElementById('onlineUsers');
const wallDiv = document.getElementById('wall');
const form = document.getElementById('sendForm');
const nameInput = document.getElementById('nameInput');
const textInput = document.getElementById('textInput');
const clearBtn = document.getElementById('clearBtn');
const clearModal = document.getElementById('clearModal');
const clearPassword = document.getElementById('clearPassword');
const confirmClearBtn = document.getElementById('confirmClearBtn');
const cancelClearBtn = document.getElementById('cancelClearBtn');
const clearError = document.getElementById('clearError');
const scrollBottomBtn = document.getElementById('scrollBottomBtn');
const adminRequests = document.getElementById('adminRequests');
const editModal = document.getElementById('editModal');
const editName = document.getElementById('editName');
const editText = document.getElementById('editText');
const editTime = document.getElementById('editTime');
const saveEditBtn = document.getElementById('saveEditBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');
const notification = document.getElementById('notification');
const timerFullscreen = document.getElementById('timerFullscreen');
const timerFullscreenDisplay = document.getElementById('timerFullscreenDisplay');
const timerFullscreenExitBtn = document.getElementById('timerFullscreenExitBtn');

// State variables
let timerSeconds = 0;
let timerInterval = null;
let isPaused = false;
let originalSeconds = 0;
let currentUserType = null; // 'user', 'admin'
let userId = null;
let userIP = 'Unknown';
let userLocation = 'Unknown';
let lastActiveTime = Date.now();
let visitCount = 0;
let activeScaryMessage = null;
let scaryMessageTimer = null;
let messages = [];
let currentEditKey = null;
let userStatus = 'active';
let lastVisitDate = null;

// Initialize admin tabs
adminTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    adminTabs.forEach(t => t.classList.remove('active'));
    tabContents.forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`${tabName}Tab`).classList.add('active');
  });
});

// Track tab visibility for scary messages
document.addEventListener('visibilitychange', () => {
  if (activeScaryMessage && document.visibilityState === 'hidden') {
    clearTimeout(scaryMessageTimer);
  } else if (activeScaryMessage && document.visibilityState === 'visible') {
    const elapsed = Date.now() - activeScaryMessage.startTime;
    const remaining = Math.max(0, activeScaryMessage.duration - elapsed);
    
    scaryMessageTimer = setTimeout(() => {
      scaryOverlay.classList.remove('active');
      activeScaryMessage = null;
    }, remaining);
  }
});

// Get user IP and location
async function getUserIP() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
    
    try {
      const geoResponse = await fetch(`https://ipinfo.io/${userIP}/json?token=5a7a07190720f4);
      const geoData = await geoResponse.json();
      userLocation = `${geoData.city || 'Unknown'}, ${geoData.country || 'Unknown'}`;
    } catch (geoError) {
      console.error('Error getting location:', geoError);
      userLocation = 'Unknown';
    }
    
    return userIP;
  } catch (error) {
    console.error('Error getting IP:', error);
    userIP = 'Unknown';
    userLocation = 'Unknown';
    return 'Unknown';
  }
}

// Generate unique user ID
function generateUserId() {
  return 'user_' + Math.random().toString(36).substr(2, 9);
}

// Track user activity
function trackUserActivity() {
  userId = localStorage.getItem('userId') || generateUserId();
  localStorage.setItem('userId', userId);
  
  // Record visit
  const today = new Date().toISOString().split('T')[0];
  lastVisitDate = today;
  const userRef = db.ref(`users/${userId}`);
  
  userRef.transaction(user => {
    if (!user) {
      return {
        ip: userIP,
        location: userLocation,
        visits: 1,
        lastVisit: Date.now(),
        created: Date.now(),
        status: 'active',
        todayVisits: 1,
        lastVisitDate: today,
        lastActive: Date.now()
      };
    }
    
    user.visits = (user.visits || 0) + 1;
    user.lastVisit = Date.now();
    user.status = userStatus;
    user.lastActive = Date.now();
    
    if (user.lastVisitDate === today) {
      user.todayVisits = (user.todayVisits || 0) + 1;
    } else {
      user.todayVisits = 1;
    }
    
    user.lastVisitDate = today;
    return user;
  });
  
  // Update last active time every minute
  setInterval(() => {
    lastActiveTime = Date.now();
    db.ref(`users/${userId}`).update({ lastActive: lastActiveTime });
  }, 60000);
  
  // Check if user is banned
  userRef.once('value').then(snapshot => {
    const userData = snapshot.val();
    if (userData && userData.status === 'banned') {
      showBanMessage();
    }
  });
}

// Show ban message
function showBanMessage() {
  banMessage.style.display = 'flex';
  mainContainer.style.display = 'none';
  chatContainer.style.display = 'none';
  userStatus = 'banned';
}

// Format date/time
function formatDate(t) {
  let d = new Date(t);
  let now = new Date();
  let diff = Math.floor((now - d) / 1000);
  if (diff < 60) return 'Just now';
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// Update stats
function updateStats() {
  const today = new Date().toISOString().split('T')[0];
  const usersRef = db.ref('users');
  
  usersRef.once('value').then(snapshot => {
    const users = snapshot.val() || {};
    const userKeys = Object.keys(users);
    
    // Total visits
    const total = userKeys.reduce((sum, key) => sum + (users[key].visits || 0), 0);
    totalVisits.textContent = total;
    
    // Today's visits
    const todayCount = userKeys.reduce((sum, key) => {
      return users[key].lastVisitDate === today ? sum + (users[key].todayVisits || 0) : sum;
    }, 0);
    todayVisits.textContent = todayCount;
    
    // Unique users
    uniqueUsers.textContent = userKeys.length;
    
    // Online users (active in last 5 minutes)
    const onlineCount = userKeys.filter(key => {
      return users[key].lastActive && (Date.now() - users[key].lastActive) < 300000;
    }).length;
    onlineUsers.textContent = onlineCount;
  });
}

// Render user list
function renderUserList() {
  const usersRef = db.ref('users');
  
  usersRef.on('value', snapshot => {
    const users = snapshot.val() || {};
    userList.innerHTML = '';
    scaryTarget.innerHTML = '<option value="">Select a user</option>';
    
    Object.keys(users).forEach(key => {
      const user = users[key];
      
      // Add to user list
      const userItem = document.createElement('div');
      userItem.className = 'user-item';
      
      const userInfo = document.createElement('div');
      userInfo.className = 'user-info';
      userInfo.innerHTML = `
        <strong>${key}</strong><br>
        <small>IP: ${user.ip || 'Unknown'}</small><br>
        <small>Location: ${user.location || 'Unknown'}</small><br>
        <small>Visits: ${user.visits || 0} (Today: ${user.todayVisits || 0})</small>
      `;
      
      const userActions = document.createElement('div');
      userActions.className = 'user-actions';
      
      if (user.status === 'banned') {
        const unbanBtn = document.createElement('button');
        unbanBtn.className = 'user-btn unban-btn';
        unbanBtn.textContent = 'Unban';
        unbanBtn.onclick = () => unbanUser(key);
        userActions.appendChild(unbanBtn);
      } else {
        const banBtn = document.createElement('button');
        banBtn.className = 'user-btn ban-btn';
        banBtn.textContent = 'Ban';
        banBtn.onclick = () => banUser(key);
        userActions.appendChild(banBtn);
        
        const messageBtn = document.createElement('button');
        messageBtn.className = 'user-btn message-btn';
        messageBtn.textContent = 'Scare';
        messageBtn.onclick = () => {
          scaryTarget.value = key;
          document.querySelector('[data-tab="scary"]').click();
        };
        userActions.appendChild(messageBtn);
      }
      
      userItem.appendChild(userInfo);
      userItem.appendChild(userActions);
      userList.appendChild(userItem);
      
      // Add to scary target dropdown
      if (user.status !== 'banned') {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${key} (${user.location || 'Unknown'})`;
        scaryTarget.appendChild(option);
      }
    });
  });
}

<!-- Complete Golden Ratio Timer with Enhanced Admin Features -->
<script>
// ... (previous script content) ...

// Ban user
function banUser(userId) {
  db.ref(`users/${userId}`).update({
    status: 'banned',
    banTime: Date.now()
  });
  showNotification(`User ${userId} banned successfully`, true);
}

// Unban user
function unbanUser(userId) {
  db.ref(`users/${userId}`).update({
    status: 'active'
  });
  showNotification(`User ${userId} unbanned successfully`, true);
}

// Send scary message
function sendScaryMessage() {
  const targetUserId = scaryTarget.value;
  const message = scaryMessageText.value.trim();

  if (!targetUserId || !message) {
    showNotification('Please select a user and enter a message', false);
    return;
  }

  db.ref(`scaryMessages/${targetUserId}`).set({
    message: message,
    sentAt: Date.now(),
    sender: userId,
    status: 'pending',
    duration: 5000 // 5 seconds duration
  });

  scaryMessageText.value = '';
  showNotification('Scary message sent!', true);
}

// Show scary message
function showScaryMessage(message, duration) {
  scaryMessage.textContent = message;
  scaryOverlay.classList.add('active');

  // Set timer
  activeScaryMessage = {
    userId: userId,
    message: message,
    startTime: Date.now(),
    duration: duration,
    timeLeft: duration
  };

  scaryMessageTimer = setTimeout(() => {
    scaryOverlay.classList.remove('active');
    activeScaryMessage = null;
  }, duration);
}

// Check for scary messages
function checkScaryMessages() {
  db.ref(`scaryMessages/${userId}`).on('value', snapshot => {
    const messageData = snapshot.val();
    if (messageData && messageData.status === 'pending') {
      // Mark as delivered
      db.ref(`scaryMessages/${userId}`).update({
        status: 'delivered',
        deliveredAt: Date.now()
      });

      // Show message if user is active
      if (document.visibilityState === 'visible') {
        showScaryMessage(messageData.message, messageData.duration);
      }
    }
  });
}

// Show notification
function showNotification(message, isSuccess = true) {
  notification.textContent = message;
  notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
  notification.classList.add('show');

  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// TIMER FUNCTIONS
function formatTimer(secs) {
  secs = Math.max(0, Math.floor(secs));
  let h = Math.floor(secs/3600);
  let m = Math.floor((secs%3600)/60);
  let s = secs%60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function showTimerError(msg) {
  timerError.textContent = msg;
  timerError.style.display = "block";
}

function hideTimerError() {
  timerError.textContent = "";
  timerError.style.display = "none";
}

function parseTimeInput(val) {
  val = val.trim();
  if (!val) return null;
  let parts = val.split(':').map(x=>x.trim());
  if (parts.length === 1) {
    if (/^\d+$/.test(parts[0])) {
      return parseInt(parts[0],10);
    }
    return null;
  } else if (parts.length === 2) {
    if (/^\d+$/.test(parts[0]) && /^\d+$/.test(parts[1])) {
      return parseInt(parts[0],10)*60 + parseInt(parts[1],10);
    }
    return null;
  } else if (parts.length === 3) {
    if (/^\d+$/.test(parts[0]) && /^\d+$/.test(parts[1]) && /^\d+$/.test(parts[2])) {
      return parseInt(parts[0],10)*3600 + parseInt(parts[1],10)*60 + parseInt(parts[2],10);
    }
    return null;
  } else {
    return null;
  }
}

function updateTimerDisplay() {
  timerDisplay.textContent = formatTimer(timerSeconds);
  timerFullscreenDisplay.text极狐Content = formatTimer(timerSeconds);
}

function startTimer() {
  if (timerSeconds <= 0) return;
  isPaused = false;
  pauseBtn.textContent = "Pause";
  pauseBtn.disabled = false;
  resetBtn.disabled = false;
  startBtn.disabled = true;
  timerInput.disabled = true;
  fullscreenBtn.disabled = false;
  timerInterval = setInterval(()=>{
    if (!isPaused && timerSeconds > 0) {
      timerSeconds--;
      updateTimerDisplay();
      if (timerSeconds <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        pauseBtn.disabled = true;
        startBtn.disabled = false;
        timerInput.disabled = false;
        fullscreenBtn.disabled = true;
      }
    }
  }, 1000);
}

function resetTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  timerSeconds = originalSeconds;
  updateTimerDisplay();
  pauseBtn.textContent = "Pause";
  pauseBtn.disabled = true;
  resetBtn.disabled = true;
  startBtn.disabled = false;
  timerInput.disabled = false;
  fullscreenBtn.disabled = false;
  isPaused = false;
}

// CHAT FUNCTIONS
function renderWall() {
  wallDiv.innerHTML = '';
  messages.forEach(msg => appendMessageCard(msg));
  scrollWallToBottom();
}

function appendMessageCard(msg) {
  const card = document.createElement('div');
  card.className = 'msgCard';
  const hdr = document.createElement('div');
  hdr.className = 'msgHeader';
  const name = document.createElement('span');
  name.className = 'msgName';
  name.textContent = msg.name;
  hdr.appendChild(name);
  const time = document.createElement('span');
  time.className = 'msgTime';
  time.textContent = formatDate(msg.time);
  hdr.appendChild(time);
  card.appendChild(hdr);
  const txt = document.createElement('div');
  txt.className = 'msgText';
  txt.textContent = msg.text;
  card.appendChild(txt);

  // Add edit button for admins
  if (currentUserType === 'admin') {
    const editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.textContent = 'Edit';
    editBtn.onclick = function() {
      openEditModal(msg.key, msg);
    };
    card.appendChild(editBtn);
  }

  wallDiv.appendChild(card);
}

function scrollWallToBottom() {
  wallDiv.scrollTop = wallDiv.scrollHeight;
}

// Initialize the app
async function initApp() {
  await getUserIP();
  trackUserActivity();

  if (currentUserType === 'admin') {
    updateStats();
    renderUserList();
    setInterval(updateStats, 60000); // Update stats every minute
  }

  checkScaryMessages();
}

// EVENT LISTENERS
startBtn.addEventListener('click', function() {
  hideTimerError();
  let val = timerInput.value;

  // Check for passwords
  if(val === USER_PASSWORD){
    currentUserType = 'user';
    mainContainer.style.display = "none";
    chatContainer.style.display = "block";
    appsBtn.classList.add("show");
    adminPanel.style.display = "none";
    getUserIP().then(trackUserActivity);
    return;
  }
  if(val === ADMIN_PASSWORD){
    currentUserType = 'admin';
    mainContainer.style.display = "none";
    chatContainer.style.display = "block";
    appsBtn.classList.add("show");
    adminPanel.style.display = "block";
    initApp();
    return;
  }

  let secs = parseTimeInput(val);
  if (secs === null || secs <= 0 || secs > 86400) {
    showTimerError("Invalid format. Use hours:minutes:seconds (max 24h). Examples: 90, 1:30, 1:5:30, 0:2:10");
    return;
  }
  timerSeconds = secs;
  originalSeconds = secs;
  updateTimerDisplay();
  startTimer();
});

pauseBtn.addEventListener('click', function() {
  if (!timerInterval) return;
  isPaused = !isPaused;
  pauseBtn.textContent = isPaused ? "Resume" : "Pause";
});

resetBtn.addEventListener('click', resetTimer);

timerInput.addEventListener('input', hideTimerError);

// Fullscreen logic
fullscreenBtn.addEventListener('click', function() {
  timerFullscreen.style.display = "flex";
  timerFullscreenDisplay.textContent = timerDisplay.textContent;
  document.body.style.overflow = "hidden";
});

timerFullscreenExitBtn.addEventListener('click', function() {
  timerFullscreen.style.display = "none";
  document.body.style.overflow = "";
});

window.addEventListener("keydown", function(e){
  if (timerFullscreen.style.display === "flex" && (e.key === "Escape" || e.key === "Esc")) {
    timerFullscreen.style.display = "none";
    document.body.style.overflow = "";
  }
});

// Form submission
if(form) {
  form.addEventListener('submit', e => {
    e.preventDefault();
    let name = nameInput.value.trim();
    let text = textInput.value.trim();

    if(!name || !text) return;

    // Basic sanitization
    name = name.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    text = text.replace(/</g,"&lt;").replace(/>/g,"&gt;");

    let msg = {
      name,
      text,
      time: Date.now()
    };

    db.ref('messages').push(msg);
    textInput.value = '';
    textInput.focus();
  });
}

// Clear button handling
if(clearBtn) {
  clearBtn.addEventListener('click', function() {
    if (currentUserType === 'admin') {
      // Admin can clear immediately
      db.ref('messages').set({});
      showNotification('Chat cleared successfully', true);
    } else {
      // Normal user needs to request clearance
      clearModal.style.display = 'flex';
      clearPassword.value = '';
      clearError.textContent = '';
      clearError.style.display = 'none';
      clearPassword.focus();
    }
  });
}

// Clear modal handling
if(cancelClearBtn) {
  cancelClearBtn.addEventListener('click', function() {
    clearModal.style.display = 'none';
  });
}

if(confirmClearBtn) {
  confirmClearBtn.addEventListener('click', function() {
    if (clearPassword.value === CLEARANCE_PASSWORD) {
      // Submit clearance request
      db.ref('clearanceRequests').push({
        name: nameInput.value || 'Anonymous',
        time: Date.now(),
        userId: userId
      });
      clearModal.style.display = 'none';
      showNotification('Clearance request sent to your future self', true);
    } else {
      clearError.textContent = 'Incorrect password!';
      clearError.style.display = 'block';
      clearPassword.value = '';
      clearPassword.focus();
    }
  });

  clearPassword.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      confirmClearBtn.click();
    }
  });
}

// Edit modal handling
saveEditBtn.addEventListener('click', function() {
  const newName = editName.value.trim();
  const newText = editText.value.trim();

  if (!newName || !newText) {
    showNotification('Name and message cannot be empty', false);
    return;
  }

  db.ref(`messages/${currentEditKey}`).update({
    name: newName,
    text: newText
  });

  editModal.style.display = 'none';
  showNotification('Message updated successfully', true);
});

cancelEditBtn.addEventListener('click', function() {
  editModal.style.display = 'none';
});

// Scroll to bottom button
if (scrollBottomBtn && wallDiv) {
  scrollBottomBtn.addEventListener('click', function() {
    wallDiv.scrollTop = wallDiv.scrollHeight;
  });
}

// Close modals when clicking outside
window.addEventListener('click', function(e) {
  if (e.target === clearModal) {
    clearModal.style.display = 'none';
  }
  if (e.target === editModal) {
    editModal.style.display = 'none';
  }
});

// Firebase listeners
db.ref('messages').on('value', snapshot => {
  const val = snapshot.val() || {};
  messages = Object.keys(val).map(k => ({ ...val[k], key: k })).sort((a,b) => a.time - b.time);
  renderWall();
});

db.ref('clearanceRequests').on('value', snapshot => {
  const requests = snapshot.val() || {};
  adminRequests.innerHTML = '';

  Object.keys(requests).forEach(key => {
    const request = requests[key];
    const requestItem = document.createElement('div');
    requestItem.className = 'request-item';

    const requestInfo = document.createElement('div');
    requestInfo.className = 'request-info';
    requestInfo.innerHTML = `
      <strong>${request.name}</strong> requested clearance<br>
      <small>${formatDate(request.time)}</small>
    `;

    const requestActions = document.createElement('div');
    requestActions.className = 'request-actions';

    const approveBtn = document.createElement('button');
    approveBtn.className = 'request-btn approve-btn';
    approveBtn.textContent = 'Approve';
    approveBtn.onclick = function() {
      db.ref(`clearanceRequests/${key}`).remove();
      db.ref('messages').set({});
      showNotification('Chat cleared successfully', true);
    };

    const denyBtn = document.createElement('button');
    denyBtn.className = 'request-btn deny-btn';
    denyBtn.textContent = 'Deny';
    denyBtn.onclick = function() {
      db.ref(`clearanceRequests/${key}`).remove();
      showNotification('Request denied', false);
    };

    requestActions.appendChild(approveBtn);
    requestActions.appendChild(denyBtn);
    requestItem.appendChild(requestInfo);
    requestItem.appendChild(requestActions);
    adminRequests.appendChild(requestItem);
  });
});

// Scary message button
sendScaryBtn.addEventListener('click', sendScaryMessage);

// Initialize timer display
updateTimerDisplay();
</script>
</body>
</html>
